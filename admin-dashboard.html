<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ADMIN DASHBOARD v6.0 - 2024-12-29 - GLB UPLOAD SUPPORT ADDED -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Dashboard - MocapWork</title>
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0F0F0F;
            --bg-card: rgba(26, 26, 26, 0.6);
            --teal: #F59E0B;
            --teal-light: #FBBF24;
            --amber: #FF6B6B;
            --amber-light: #FF8E8E;
            --green: #10B981;
            --red: #EF4444;
            --text-primary: #FEFCE8;
            --text-secondary: #E7E5D3;
            --text-muted: #A8A593;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Custom Scrollbar - Grey with Orange Accent */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #F59E0B 0%, #FF6B6B 100%);
            border-radius: 6px;
            border: 2px solid #1a1a1a;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #FBBF24 0%, #FF8E8E 100%);
        }

        /* Firefox Scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: #F59E0B #1a1a1a;
        }

        /* Header */
        .admin-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid rgba(100, 116, 139, 0.1);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-logo {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--teal), var(--amber));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-email {
            color: var(--text-muted);
            font-size: 14px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--red);
            border-radius: 8px;
            color: var(--red);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: var(--red);
            color: white;
        }

        .back-to-site-btn {
            padding: 8px 16px;
            background: rgba(100, 116, 139, 0.1);
            border: 1px solid var(--teal);
            border-radius: 8px;
            color: var(--teal);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .back-to-site-btn:hover {
            background: var(--teal);
            color: var(--bg-primary);
        }

        /* Main Layout */
        .admin-container {
            display: flex;
            min-height: calc(100vh - 81px);
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid rgba(100, 116, 139, 0.1);
            padding: 24px;
            position: fixed;
            top: 81px;
            left: 0;
            height: calc(100vh - 81px);
            overflow-y: auto;
            z-index: 50;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .nav-item {
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }

        .nav-item:hover {
            background: rgba(100, 116, 139, 0.1);
            color: var(--teal);
        }

        .nav-item.active {
            background: rgba(100, 116, 139, 0.15);
            color: var(--teal);
            font-weight: 600;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 40px;
            margin-left: 260px;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--teal), var(--amber));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 16px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 116, 139, 0.1);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--teal);
            transform: translateY(-4px);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--teal), var(--amber));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-change {
            font-size: 12px;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: var(--green);
        }

        /* Content Card */
        .content-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 116, 139, 0.1);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .form-grid.full {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 12px 16px;
            background: rgba(20, 20, 20, 0.5);
            border: 1px solid rgba(100, 116, 139, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--teal);
            box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(156, 163, 175, 0.3);
            transition: 0.4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--teal), var(--amber));
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: var(--teal);
            background: rgba(100, 116, 139, 0.05);
        }

        .file-upload.dragover {
            border-color: var(--amber);
            background: rgba(245, 158, 11, 0.05);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 12px;
            color: var(--text-muted);
        }

        .file-preview {
            margin-top: 16px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .preview-item {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid rgba(100, 116, 139, 0.2);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--teal), var(--amber));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(100, 116, 139, 0.4);
        }

        .btn-secondary {
            background: rgba(100, 116, 139, 0.1);
            border: 1px solid var(--teal);
            color: var(--teal);
        }

        .btn-secondary:hover {
            background: rgba(100, 116, 139, 0.2);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--red);
            color: var(--red);
        }

        .btn-danger:hover {
            background: var(--red);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(100, 116, 139, 0.3);
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider::before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #fb7d47, #10B981);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(28px);
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid rgba(100, 116, 139, 0.2);
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 16px 12px;
            border-bottom: 1px solid rgba(100, 116, 139, 0.1);
        }

        .data-table tr:hover {
            background: rgba(100, 116, 139, 0.05);
        }

        .table-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        .action-btn.edit {
            background: rgba(100, 116, 139, 0.1);
            color: var(--teal);
        }

        .action-btn.delete {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        /* Badge */
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-popular {
            background: rgba(245, 158, 11, 0.2);
            color: var(--amber);
        }

        .badge-sale {
            background: rgba(16, 185, 129, 0.2);
            color: var(--green);
        }

        .badge-holiday {
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .spinner {
            border: 3px solid rgba(100, 116, 139, 0.1);
            border-top: 3px solid var(--teal);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .notification.success {
            background: rgba(16, 185, 129, 0.9);
            border: 2px solid var(--green);
            color: white;
        }

        .notification.error {
            background: rgba(239, 68, 68, 0.9);
            border: 2px solid var(--red);
            color: white;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Search & Filter */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            gap: 16px;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: rgba(20, 20, 20, 0.5);
            border: 1px solid rgba(100, 116, 139, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%239CA3AF' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cpath d='m21 21-4.35-4.35'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 12px center;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* GIF Queue Grid Layout */
        #gifQueueList {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
            gap: 16px !important;
        }
        
        #gifQueueList > div {
            flex-direction: column !important;
        }
        
        #gifQueueList .item-preview {
            margin: 0 auto 12px auto !important;
        }
        
        #gifQueueList .item-controls {
            flex-wrap: wrap !important;
            justify-content: center !important;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 116, 139, 0.1);
            border-radius: 16px;
            padding: 48px;
            width: 100%;
            max-width: 400px;
        }

        .login-logo {
            text-align: center;
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--teal), var(--amber));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 32px;
        }

        /* Edit Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid rgba(100, 116, 139, 0.2);
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(100, 116, 139, 0.2);
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--teal), var(--amber));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 28px;
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--red);
        }

        .modal-content .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .modal-content .form-group {
            margin-bottom: 16px;
        }

        .modal-content .btn-group {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid rgba(100, 116, 139, 0.2);
        }

        .pipeline-filter.active {
            background: var(--teal) !important;
            color: var(--bg-primary) !important;
            border-color: var(--teal) !important;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-logo">MocapWork Admin</div>
            <p style="text-align: center; color: var(--text-muted); margin-bottom: 24px;">
                You must be logged in as an admin to access this page
            </p>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 24px;">
                    Sign In to Admin
                </button>
                <div style="text-align: center; margin-top: 20px;">
                    <a href="index.html" style="color: var(--teal); text-decoration: none; font-size: 14px;">‚Üê Back to Main Site</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Header -->
        <header class="admin-header">
            <div class="admin-logo">MocapWork Admin</div>
            <div class="admin-user">
                <span class="user-email" id="userEmail"></span>
                <a href="index.html" class="back-to-site-btn">‚Üê Back to Site</a>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </header>

        <div class="admin-container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="nav-section">
                    <div class="nav-title">Main</div>
                    <div class="nav-item active" onclick="showPage('overview')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        <span>Overview</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Animations</div>
                    <div class="nav-item" onclick="showPage('add-animation')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span>Add New</span>
                    </div>
                    <div class="nav-item" onclick="showPage('all-animations')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        <span>All Animations</span>
                    </div>
                    <div class="nav-item" onclick="showPage('bulk-edit')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        <span>Bulk Edit</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Content</div>
                    <div class="nav-item" onclick="showPage('carousel')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span>Hero Carousel</span>
                    </div>
                    <div class="nav-item" onclick="showPage('tags')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                        </svg>
                        <span>Manage Tags</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Settings</div>
                    <div class="nav-item" onclick="showPage('offers')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                        </svg>
                        <span>Offers Panel</span>
                    </div>
                    <div class="nav-item" onclick="showPage('users')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <span>User Management</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Tools</div>
                    <div class="nav-item" onclick="showPage('gif-converter')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span>GIF Converter</span>
                    </div>
                    <div class="nav-item" onclick="showPage('pipeline')">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                        <span>Pipeline</span>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Overview Page -->
                <div id="overviewPage" class="page">
                    <div class="page-header">
                        <h1 class="page-title">Dashboard Overview</h1>
                        <p class="page-subtitle">Manage your motion capture library</p>
                    </div>

                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Animations</div>
                            <div class="stat-value" id="totalAnimations">0</div>
                            <div class="stat-change positive">‚Üë View all</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Popular Items</div>
                            <div class="stat-value" id="popularCount">0</div>
                            <div class="stat-change">Marked as popular</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">On Sale</div>
                            <div class="stat-value" id="onSaleCount">0</div>
                            <div class="stat-change">Active sales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Categories</div>
                            <div class="stat-value" id="categoriesCount">0</div>
                            <div class="stat-change">Different types</div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="content-card">
                        <h2 class="card-title">Recent Additions</h2>
                        <div id="recentAnimations" class="loading">
                            <div class="spinner"></div>
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- Add Animation Page -->
                <div id="addAnimationPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">Add New Animation</h1>
                        <p class="page-subtitle">Create a new motion capture listing</p>
                    </div>

                    <div class="content-card">
                        <form id="addAnimationForm" onsubmit="handleAddAnimation(event)">
                            <!-- Basic Info -->
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Title *</label>
                                    <input type="text" class="form-input" name="title" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Slug *</label>
                                    <input type="text" class="form-input" name="slug" required placeholder="auto-generated-from-title">
                                </div>
                            </div>

                            <div class="form-grid full">
                                <div class="form-group">
                                    <label class="form-label">Description *</label>
                                    <textarea class="form-textarea" name="description" required></textarea>
                                </div>
                            </div>

                            <!-- Pricing & Details -->
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Price (USD) *</label>
                                    <input type="number" step="0.01" class="form-input" name="price" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Duration *</label>
                                    <input type="text" class="form-input" name="duration" placeholder="2:30" required>
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Category *</label>
                                    <select class="form-select" name="category" required>
                                        <option value="">Select Category</option>
                                        <option value="Combat">Combat</option>
                                        <option value="Locomotion">Locomotion</option>
                                        <option value="Dance">Dance</option>
                                        <option value="Sports">Sports</option>
                                        <option value="Lifestyle">Lifestyle</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Sale Percentage (%)</label>
                                    <input type="number" min="0" max="100" class="form-input" name="sale_percentage" placeholder="0">
                                </div>
                            </div>

                            <!-- Technical Specs -->
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">File Size</label>
                                    <input type="text" class="form-input" name="file_size" placeholder="50 MB">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Frame Rate</label>
                                    <input type="text" class="form-input" name="frame_rate" placeholder="30 fps">
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Resolution</label>
                                    <input type="text" class="form-input" name="resolution" placeholder="1920x1080">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Format</label>
                                    <input type="text" class="form-input" name="format" placeholder="FBX, BVH">
                                </div>
                            </div>

                            <div class="form-grid full">
                                <div class="form-group">
                                    <label class="form-label">Compatible With</label>
                                    <input type="text" class="form-input" name="compatible_with" placeholder="Unreal Engine, Unity, Blender">
                                </div>
                            </div>

                            <!-- File Upload -->
                            <div class="form-group">
                                <label class="form-label">Animation GIF/Video</label>
                                <div class="file-upload" id="videoUpload" onclick="document.getElementById('videoFile').click()">
                                    <div class="upload-icon">üìÅ</div>
                                    <div class="upload-text">Click to upload or drag and drop</div>
                                    <div class="upload-hint">GIF, MP4 (Max 50MB)</div>
                                </div>
                                <input type="file" id="videoFile" accept="image/gif,video/mp4" style="display:none" onchange="handleFileSelect(event, 'video')">
                                <div id="videoPreview" class="file-preview"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Thumbnail Image</label>
                                <div class="file-upload" id="thumbnailUpload" onclick="document.getElementById('thumbnailFile').click()">
                                    <div class="upload-icon">üñºÔ∏è</div>
                                    <div class="upload-text">Click to upload thumbnail</div>
                                    <div class="upload-hint">PNG, JPG (Max 10MB)</div>
                                </div>
                                <input type="file" id="thumbnailFile" accept="image/*" style="display:none" onchange="handleFileSelect(event, 'thumbnail')">
                                <div id="thumbnailPreview" class="file-preview"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Downloadable File (FBX, BVH, etc.)</label>
                                <div class="file-upload" id="downloadUpload" onclick="document.getElementById('downloadFile').click()">
                                    <div class="upload-icon">üì¶</div>
                                    <div class="upload-text">Click to upload downloadable file</div>
                                    <div class="upload-hint">FBX, BVH, ZIP (Max 100MB) - This is what users download</div>
                                </div>
                                <input type="file" id="downloadFile" accept=".fbx,.bvh,.zip,.rar,.7z" style="display:none" onchange="handleFileSelect(event, 'download')">
                                <div id="downloadPreview" class="file-preview"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">3D Preview File (GLB) - For 3D Viewer</label>
                                <div class="file-upload" id="glbUpload" onclick="document.getElementById('glbFile').click()">
                                    <div class="upload-icon">üéÆ</div>
                                    <div class="upload-text">Click to upload GLB file</div>
                                    <div class="upload-hint">GLB format only (Max 100MB) - Used for 3D preview viewer</div>
                                </div>
                                <input type="file" id="glbFile" accept=".glb" style="display:none" onchange="handleGlbSelect(event)">
                                <div id="glbPreview" class="file-preview"></div>
                            </div>

                            <!-- Toggles -->
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Badges</label>
                                    <div class="toggle-group">
                                        <label class="toggle-switch">
                                            <input type="checkbox" name="popular">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span>Popular</span>
                                    </div>
                                    <div class="toggle-group" style="margin-top: 12px;">
                                        <label class="toggle-switch">
                                            <input type="checkbox" name="on_sale">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span>On Sale</span>
                                    </div>
                                    <div class="toggle-group" style="margin-top: 12px;">
                                        <label class="toggle-switch">
                                            <input type="checkbox" name="holiday_sale">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span>Holiday Sale</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit -->
                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    Create Animation
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('addAnimationForm').reset()">
                                    Reset Form
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- All Animations Page -->
                <div id="allAnimationsPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">All Animations</h1>
                        <p class="page-subtitle">Manage your entire library</p>
                    </div>

                    <div class="content-card">
                        <div class="toolbar">
                            <div class="search-box">
                                <input type="text" class="search-input" id="searchAnimations" placeholder="Search animations...">
                            </div>
                            <button class="btn btn-primary" onclick="showPage('add-animation')">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Add New
                            </button>
                        </div>

                        <div id="animationsTable" class="loading">
                            <div class="spinner"></div>
                            Loading animations...
                        </div>
                    </div>
                </div>

                <!-- Bulk Edit Page -->
                <div id="bulkEditPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">Bulk Operations</h1>
                        <p class="page-subtitle">Edit multiple animations at once</p>
                    </div>

                    <div class="content-card">
                        <h2 class="card-title">Bulk Actions</h2>
                        <p style="color: var(--text-muted); margin-bottom: 24px;">
                            Select animations from the "All Animations" page, then apply bulk changes here.
                        </p>

                        <div class="form-grid">
                            <button class="btn btn-secondary" onclick="bulkToggle('popular', true)">
                                Set All as Popular
                            </button>
                            <button class="btn btn-secondary" onclick="bulkToggle('on_sale', true)">
                                Put All on Sale
                            </button>
                            <button class="btn btn-secondary" onclick="bulkUpdatePrice(0.8)">
                                Apply 20% Discount
                            </button>
                            <button class="btn btn-danger" onclick="bulkDelete()">
                                Delete Selected
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tags Page -->
                <!-- Hero Carousel Management Page -->
                <div id="carouselPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">Hero Carousel</h1>
                        <p class="page-subtitle">Manage the hero section carousel items</p>
                    </div>

                    <div class="content-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h2 class="card-title">Carousel Items (7 items)</h2>
                            <button onclick="saveCarouselItems()" style="background: var(--teal); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Save Changes
                            </button>
                        </div>
                        
                        <div id="carouselItemsList" style="display: flex; flex-direction: column; gap: 20px;">
                            <!-- Carousel items will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Tags Management Page -->
                <div id="tagsPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">Manage Tags</h1>
                        <p class="page-subtitle">Organize animation categories and tags</p>
                    </div>

                    <div class="content-card">
                        <h2 class="card-title">Coming Soon</h2>
                        <p style="color: var(--text-muted);">
                            Tag management interface will be available in the next update.
                        </p>
                    </div>
                </div>

                <!-- User Management Page -->
                <!-- Offers Panel Page -->
                <div id="offersPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">Offers Panel</h1>
                        <p class="page-subtitle">Control visibility of promotional banners and offers on the main site</p>
                    </div>

                    <!-- Current Status -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, rgba(251, 125, 71, 0.2), rgba(251, 125, 71, 0.05));">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #fb7d47;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Offers Status</div>
                                <div class="stat-value" id="offersStatus">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Offers Toggle -->
                    <div class="content-card">
                        <h2 class="card-title">Premium Banner</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            The banner that shows "Limited Time: New animations added weekly!" and pricing info at the top of the library.
                        </p>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="premiumBannerToggle" onchange="toggleOffer('premium_banner', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <span id="premiumBannerStatus" style="color: var(--text-secondary);">Loading...</span>
                        </div>
                    </div>

                    <div class="content-card">
                        <h2 class="card-title">Rewards Banner</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            The banner that shows "MocapWork Rewards Program" below the library section.
                        </p>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="rewardsBannerToggle" onchange="toggleOffer('rewards_banner', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <span id="rewardsBannerStatus" style="color: var(--text-secondary);">Loading...</span>
                        </div>
                    </div>

                    <div class="content-card">
                        <h2 class="card-title">AI Recommendations</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            The AI-powered recommendations toggle and banner in the library filters.
                        </p>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="aiRecommendationsToggle" onchange="toggleOffer('ai_recommendations', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <span id="aiRecommendationsStatus" style="color: var(--text-secondary);">Loading...</span>
                        </div>
                    </div>

                    <div class="content-card">
                        <h2 class="card-title">Can't Find Animation CTA</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            The "Can't Find the Perfect Animation?" call-to-action banner.
                        </p>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="ctaBannerToggle" onchange="toggleOffer('cta_banner', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <span id="ctaBannerStatus" style="color: var(--text-secondary);">Loading...</span>
                        </div>
                    </div>

                    <div class="content-card" style="border: 2px solid rgba(251, 125, 71, 0.3);">
                        <h2 class="card-title" style="display: flex; align-items: center; gap: 8px;">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="#fb7d47" stroke="none"><path d="M12 23c-3.866 0-7-3.134-7-7 0-2.526 1.394-4.727 3.453-5.882-.07.463-.107.943-.107 1.432 0 2.485 1.349 4.656 3.354 5.822-.696-.772-1.121-1.795-1.121-2.922 0-2.209 1.672-4.013 3.82-4.245.138-.015.277-.023.417-.023 1.115 0 2.133.44 2.884 1.16A6.968 6.968 0 0 1 19 16c0 3.866-3.134 7-7 7zM12 1c.552 0 1 .448 1 1v2c0 .552-.448 1-1 1s-1-.448-1-1V2c0-.552.448-1 1-1z"/></svg>
                            Special Offer Button
                        </h2>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            The floating "Special Offer" button on the right side of the screen that opens the promo popup.
                        </p>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="specialOfferToggle" onchange="toggleOffer('special_offer_button', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <span id="specialOfferStatus" style="color: var(--text-secondary);">Loading...</span>
                        </div>
                    </div>

                    <div style="margin-top: 24px; padding: 16px; background: rgba(251, 125, 71, 0.1); border: 2px solid rgba(251, 125, 71, 0.2); border-radius: 12px;">
                        <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">
                            <strong style="color: #fb7d47;">üí° Note:</strong> Changes take effect immediately on the main site. Visitors will see the updated state on their next page load.
                        </p>
                    </div>
                </div>

                <div id="usersPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">User Management</h1>
                        <p class="page-subtitle">Manage admin access and user roles</p>
                    </div>

                    <!-- User Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, rgba(100, 116, 139, 0.2), rgba(100, 116, 139, 0.05));">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--teal);">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Total Users</div>
                                <div class="stat-value" id="totalUsersCount">-</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.05));">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--amber);">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Admins</div>
                                <div class="stat-value" id="totalAdminsCount">-</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.05));">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--green);">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Regular Users</div>
                                <div class="stat-value" id="regularUsersCount">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Add Admin Form -->
                    <div class="content-card">
                        <h2 class="card-title">Add New Admin</h2>
                        <form id="addAdminForm" onsubmit="handleAddAdmin(event)">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">User Email *</label>
                                    <input type="email" class="form-input" name="admin_email" placeholder="admin@example.com" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary">
                                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                        </svg>
                                        Grant Admin Access
                                    </button>
                                </div>
                            </div>
                            <p style="color: var(--text-muted); font-size: 14px; margin-top: 12px;">
                                ‚ÑπÔ∏è The user must have already signed up on your site before you can make them an admin.
                            </p>
                        </form>
                    </div>

                    <!-- Current Admins -->
                    <div class="content-card">
                        <h2 class="card-title">Current Admins</h2>
                        <div id="adminsList" class="loading">
                            <div class="spinner"></div>
                            Loading admins...
                        </div>
                    </div>

                    <!-- All Users -->
                    <div class="content-card">
                        <h2 class="card-title">All Users</h2>
                        <div id="allUsersList" class="loading">
                            <div class="spinner"></div>
                            Loading users...
                        </div>
                    </div>
                </div>

                <!-- GIF Converter Page -->
                <div id="gifConverterPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">GIF Converter</h1>
                        <p class="page-subtitle">Convert GLB/FBX animations to GIF thumbnails</p>
                    </div>

                    <div class="content-card">
                        <h2 class="card-title">Upload Animations</h2>
                        
                        <!-- Drop Zone -->
                        <div id="gifDropZone" style="border: 2px dashed rgba(126, 211, 33, 0.3); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 24px;">
                            <img src="pnut.jpg" style="width: 48px; height: 48px; margin-bottom: 16px; border-radius: 50%; object-fit: cover;">
                            <p style="color: var(--text-primary); margin-bottom: 8px;">Drag & drop GLB or FBX files here</p>
                            <p style="color: var(--text-muted); font-size: 14px;">Add up to 20 files at once HELLLLL YEAHHHHHH!! üî•</p>
                            <input type="file" id="gifFileInput" accept=".glb,.fbx,.gltf" multiple style="display: none;">
                        </div>

                        <!-- Background Option -->
                        <div class="form-group" style="margin-bottom: 24px; max-width: 200px;">
                            <label class="form-label">Background Color</label>
                            <select class="form-input" id="gifBackground">
                                <option value="#0a0a0a" selected>Dark (#0a0a0a)</option>
                                <option value="#000000">Black</option>
                                <option value="#ffffff">White</option>
                                <option value="#1a1a2e">Navy</option>
                                <option value="#0f0f0f">Near Black</option>
                            </select>
                        </div>

                        <!-- File Queue -->
                        <div id="gifQueue" style="display: none; margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="color: var(--text-primary); margin: 0;">Upload Queue</h3>
                                <div style="display: flex; gap: 12px;">
                                    <button type="button" class="btn btn-secondary" onclick="clearGifQueue()">Clear All</button>
                                    <button type="button" class="btn btn-primary" id="convertAllBtn" onclick="convertAllGifs()">
                                        <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        Convert All
                                    </button>
                                </div>
                            </div>
                            
                            <div id="gifQueueList" style="display: flex; flex-direction: column; gap: 12px;"></div>
                        </div>

                        <!-- Batch Progress -->
                        <div id="batchProgress" style="display: none; margin-bottom: 24px;">
                            <div style="background: rgba(126, 211, 33, 0.1); border: 1px solid rgba(126, 211, 33, 0.2); border-radius: 12px; padding: 20px;">
                                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                                    <div class="gif-loader" style="width: 40px; height: 40px; border: 3px solid rgba(126, 211, 33, 0.2); border-top-color: var(--green); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                    <div>
                                        <div id="batchProgressLabel" style="color: var(--text-primary); font-weight: 500;">Starting conversion...</div>
                                        <div id="batchProgressDetail" style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">Preparing files...</div>
                                    </div>
                                    <div style="margin-left: auto; text-align: right;">
                                        <div id="batchProgressPercent" style="color: var(--green); font-size: 24px; font-weight: 600;">0%</div>
                                        <div id="batchProgressCount" style="color: var(--text-muted); font-size: 13px;">0/0 files</div>
                                    </div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                                    <div id="batchProgressBar" style="background: linear-gradient(90deg, var(--green), #9be654); height: 100%; width: 0%; transition: width 0.3s; position: relative;">
                                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 1.5s infinite;"></div>
                                    </div>
                                </div>
                            </div>
                            <style>
                                @keyframes spin { to { transform: rotate(360deg); } }
                                @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
                            </style>
                        </div>

                        <!-- Hidden Preview Canvas -->
                        <div id="gifPreviewContainer" style="width: 400px; height: 400px; position: absolute; left: -9999px; background: #0a0a0a;">
                            <div id="gifPreviewPlaceholder"></div>
                        </div>

                        <!-- Results -->
                        <div id="gifResults" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="color: var(--text-primary); margin: 0;">Generated GIFs</h3>
                                <button type="button" class="btn btn-primary" onclick="downloadAllGifs()">
                                    <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Download All
                                </button>
                            </div>
                            <div id="gifResultsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Pipeline Page -->
                <div id="pipelinePage" class="page hidden">
                    <div style="background: rgba(245, 158, 11, 0.15); border: 1px solid #F59E0B; border-radius: 8px; padding: 12px 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 20px;">üöß</span>
                        <span style="color: #F59E0B; font-weight: 600;">Still Under Construction</span>
                        <span style="color: var(--text-muted); font-size: 14px;">‚Äî Pipeline features coming soon</span>
                    </div>
                    <div class="page-header">
                        <h1 class="page-title">Animation Pipeline</h1>
                        <p class="page-subtitle">Track cleanup status of animations from raw to published</p>
                    </div>

                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card" onclick="filterPipeline('all')" style="cursor: pointer;">
                            <div class="stat-label">Total</div>
                            <div class="stat-value" id="pipelineTotal">0</div>
                            <div class="stat-change">All animations</div>
                        </div>
                        <div class="stat-card" onclick="filterPipeline('raw')" style="cursor: pointer; border-left: 3px solid #EF4444;">
                            <div class="stat-label" style="color: #EF4444;">Raw</div>
                            <div class="stat-value" id="pipelineRaw">0</div>
                            <div class="stat-change">Needs triage</div>
                        </div>
                        <div class="stat-card" onclick="filterPipeline('cleaning')" style="cursor: pointer; border-left: 3px solid #F59E0B;">
                            <div class="stat-label" style="color: #F59E0B;">Cleaning</div>
                            <div class="stat-value" id="pipelineCleaning">0</div>
                            <div class="stat-change">In progress</div>
                        </div>
                        <div class="stat-card" onclick="filterPipeline('cleaned')" style="cursor: pointer; border-left: 3px solid #3B82F6;">
                            <div class="stat-label" style="color: #3B82F6;">Cleaned</div>
                            <div class="stat-value" id="pipelineCleaned">0</div>
                            <div class="stat-change">Ready to publish</div>
                        </div>
                        <div class="stat-card" onclick="filterPipeline('published')" style="cursor: pointer; border-left: 3px solid #10B981;">
                            <div class="stat-label" style="color: #10B981;">Published</div>
                            <div class="stat-value" id="pipelinePublished">0</div>
                            <div class="stat-change">Live on site</div>
                        </div>
                    </div>

                    <div class="content-card" style="margin-bottom: 24px;">
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                            <span style="color: var(--text-muted); font-size: 14px;">Filter:</span>
                            <button class="btn btn-secondary pipeline-filter active" data-filter="all" onclick="filterPipeline('all')">All</button>
                            <button class="btn btn-secondary pipeline-filter" data-filter="raw" onclick="filterPipeline('raw')" style="border-color: #EF4444; color: #EF4444;">Raw</button>
                            <button class="btn btn-secondary pipeline-filter" data-filter="cleaning" onclick="filterPipeline('cleaning')" style="border-color: #F59E0B; color: #F59E0B;">Cleaning</button>
                            <button class="btn btn-secondary pipeline-filter" data-filter="cleaned" onclick="filterPipeline('cleaned')" style="border-color: #3B82F6; color: #3B82F6;">Cleaned</button>
                            <button class="btn btn-secondary pipeline-filter" data-filter="published" onclick="filterPipeline('published')" style="border-color: #10B981; color: #10B981;">Published</button>
                            
                            <div style="margin-left: auto; display: flex; gap: 12px;">
                                <input type="text" class="form-input" id="pipelineSearch" placeholder="Search animations..." style="width: 250px;" oninput="searchPipeline(this.value)">
                                <button class="btn btn-primary" onclick="loadPipeline()">Refresh</button>
                            </div>
                        </div>
                    </div>

                    <div class="content-card">
                        <div id="pipelineGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                            <div class="loading" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                                <div class="spinner"></div>
                                Loading pipeline...
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Animation Modal -->
    <div id="editModal" class="modal-overlay hidden" onclick="if(event.target === this) closeEditModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Animation</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editAnimationForm" onsubmit="handleSaveEdit(event)">
                <input type="hidden" id="editAnimationId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-input" id="editTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Slug *</label>
                        <input type="text" class="form-input" id="editSlug" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description *</label>
                    <textarea class="form-textarea" id="editDescription" required></textarea>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Price (USD) *</label>
                        <input type="number" step="0.01" class="form-input" id="editPrice" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration *</label>
                        <input type="text" class="form-input" id="editDuration" required>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <select class="form-select" id="editCategory" required>
                            <option value="">Select Category</option>
                            <option value="Combat">Combat</option>
                            <option value="Locomotion">Locomotion</option>
                            <option value="Dance">Dance</option>
                            <option value="Sports">Sports</option>
                            <option value="Lifestyle">Lifestyle</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sale Percentage (%)</label>
                        <input type="number" min="0" max="100" class="form-input" id="editSalePercentage">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">File Size</label>
                        <input type="text" class="form-input" id="editFileSize">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Frame Rate</label>
                        <input type="text" class="form-input" id="editFrameRate">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Resolution</label>
                        <input type="text" class="form-input" id="editResolution">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Format</label>
                        <input type="text" class="form-input" id="editFormat">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Compatible With</label>
                    <input type="text" class="form-input" id="editCompatibleWith">
                </div>

                <div class="form-group">
                    <label class="form-label">Video/GIF URL</label>
                    <input type="text" class="form-input" id="editVideoUrl">
                    <div id="editVideoPreview" style="margin-top: 8px;"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Thumbnail URL</label>
                    <input type="text" class="form-input" id="editThumbnailUrl">
                    <div id="editThumbnailPreview" style="margin-top: 8px;"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">3D Preview (GLB) URL</label>
                    <input type="text" class="form-input" id="editGlbUrl" placeholder="Supabase storage URL for GLB file">
                    <div id="editGlbPreview" style="margin-top: 8px; color: var(--text-muted); font-size: 12px;"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Badges</label>
                    <div class="toggle-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="editPopular">
                            <span class="toggle-slider"></span>
                        </label>
                        <span>Popular</span>
                    </div>
                    <div class="toggle-group" style="margin-top: 12px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="editOnSale">
                            <span class="toggle-slider"></span>
                        </label>
                        <span>On Sale</span>
                    </div>
                    <div class="toggle-group" style="margin-top: 12px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="editHolidaySale">
                            <span class="toggle-slider"></span>
                        </label>
                        <span>Holiday Sale</span>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary" id="editSubmitBtn">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        console.log('========================================');
        console.log('ADMIN DASHBOARD v6.0 - GLB UPLOAD SUPPORT ADDED!');
        console.log('Timestamp:', new Date().toISOString());
        console.log('========================================');
        
        // Supabase Configuration
        const SUPABASE_URL = 'https://ekzablbemeponkrcitco.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVremFibGJlbWVwb25rcmNpdGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NTkzNDQsImV4cCI6MjA4MTUzNTM0NH0.bhr5lIwDUA3prPuCN7mBj5Bn8lJhalPFu5MMS5I1g2I';
        const supabaseAdmin = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        });

        let currentUser = null;
        let uploadedFiles = {
            video: null,
            thumbnail: null,
            download: null,
            glb: null
        };

        // Initialize
        async function init() {
            console.log('=== ADMIN DASHBOARD INIT ===');
            
            const { data: { session }, error } = await supabaseAdmin.auth.getSession();
            
            console.log('Session:', session);
            console.log('Session error:', error);
            console.log('User:', session?.user);
            
            if (session) {
                currentUser = session.user;
                console.log('User logged in:', currentUser.email);
                
                // Check if user is actually an admin
                const { data: userRole } = await supabaseAdmin
                    .from('user_roles')
                    .select('role')
                    .eq('user_id', currentUser.id)
                    .single();
                
                console.log('User role:', userRole);
                
                if (userRole && userRole.role === 'admin') {
                    console.log('‚úÖ User is admin - showing dashboard');
                    // User is admin, show dashboard
                    showDashboard();
                } else {
                    console.log('‚ùå User is NOT admin');
                    // User is logged in but NOT admin
                    alert('Access Denied: You must be an admin to access this page.');
                    window.location.href = 'index.html';
                }
            } else {
                console.log('‚ùå No session found - showing login');
                // Not logged in at all
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentUser.email;
            loadOverviewStats();
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const { data, error } = await supabaseAdmin.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                showNotification('Login failed: ' + error.message, 'error');
            } else {
                currentUser = data.user;
                
                // Check if user is admin
                const { data: userRole } = await supabaseAdmin
                    .from('user_roles')
                    .select('role')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (userRole && userRole.role === 'admin') {
                    showDashboard();
                } else {
                    showNotification('Access Denied: You are not an admin.', 'error');
                    await supabaseAdmin.auth.signOut();
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            }
        }

        async function handleLogout() {
            await supabaseAdmin.auth.signOut();
            currentUser = null;
            showLogin();
        }

        // Page Navigation
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            // Show selected page
            const pageMap = {
                'overview': 'overviewPage',
                'add-animation': 'addAnimationPage',
                'all-animations': 'allAnimationsPage',
                'bulk-edit': 'bulkEditPage',
                'carousel': 'carouselPage',
                'tags': 'tagsPage',
                'offers': 'offersPage',
                'users': 'usersPage',
                'gif-converter': 'gifConverterPage',
                'pipeline': 'pipelinePage'
            };
            
            document.getElementById(pageMap[pageName]).classList.remove('hidden');
            event.target.closest('.nav-item').classList.add('active');

            // Load data for page
            if (pageName === 'overview') loadOverviewStats();
            if (pageName === 'all-animations') loadAllAnimations();
            if (pageName === 'carousel') loadCarouselItems();
            if (pageName === 'offers') loadOffers();
            if (pageName === 'users') loadUsers();
            if (pageName === 'pipeline') loadPipeline();
        }

        // Load Overview Stats
        async function loadOverviewStats() {
            const { data: animations, error } = await supabaseAdmin
                .from('animations')
                .select('*');

            if (animations) {
                document.getElementById('totalAnimations').textContent = animations.length;
                document.getElementById('popularCount').textContent = animations.filter(a => a.popular).length;
                document.getElementById('onSaleCount').textContent = animations.filter(a => a.on_sale || a.holiday_sale).length;
                
                const categories = [...new Set(animations.map(a => a.category))];
                document.getElementById('categoriesCount').textContent = categories.length;

                // Recent additions
                const recent = animations.slice(0, 5);
                const recentHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Badges</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recent.map(anim => `
                                <tr>
                                    <td>${anim.title}</td>
                                    <td>${anim.category}</td>
                                    <td>$${anim.price.toFixed(2)}</td>
                                    <td>
                                        ${anim.popular ? '<span class="badge badge-popular">Popular</span>' : ''}
                                        ${anim.on_sale ? '<span class="badge badge-sale">On Sale</span>' : ''}
                                        ${anim.holiday_sale ? '<span class="badge badge-holiday">Holiday</span>' : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('recentAnimations').innerHTML = recentHTML;
            }
        }

        // Pipeline Variables
        let pipelineAnimations = [];
        let pipelineFilter = 'all';
        let pipelineSearchTerm = '';

        async function loadPipeline() {
            document.getElementById('pipelineGrid').innerHTML = '<div class="loading" style="grid-column: 1 / -1; text-align: center; padding: 40px;"><div class="spinner"></div>Loading pipeline...</div>';
            
            const { data: animations, error } = await supabaseAdmin
                .from('animations')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading pipeline:', error);
                showNotification('Failed to load pipeline', 'error');
                return;
            }

            pipelineAnimations = animations || [];
            updatePipelineStats();
            renderPipelineGrid();
        }

        function updatePipelineStats() {
            const total = pipelineAnimations.length;
            const raw = pipelineAnimations.filter(a => !a.cleanup_status || a.cleanup_status === 'raw').length;
            const cleaning = pipelineAnimations.filter(a => a.cleanup_status === 'cleaning').length;
            const cleaned = pipelineAnimations.filter(a => a.cleanup_status === 'cleaned').length;
            const published = pipelineAnimations.filter(a => a.cleanup_status === 'published').length;

            document.getElementById('pipelineTotal').textContent = total;
            document.getElementById('pipelineRaw').textContent = raw;
            document.getElementById('pipelineCleaning').textContent = cleaning;
            document.getElementById('pipelineCleaned').textContent = cleaned;
            document.getElementById('pipelinePublished').textContent = published;
        }

        window.filterPipeline = function(status) {
            pipelineFilter = status;
            document.querySelectorAll('.pipeline-filter').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === status) btn.classList.add('active');
            });
            renderPipelineGrid();
        };

        window.searchPipeline = function(term) {
            pipelineSearchTerm = term.toLowerCase();
            renderPipelineGrid();
        };

        function renderPipelineGrid() {
            let filtered = pipelineAnimations;
            
            if (pipelineFilter !== 'all') {
                if (pipelineFilter === 'raw') {
                    filtered = filtered.filter(a => !a.cleanup_status || a.cleanup_status === 'raw');
                } else {
                    filtered = filtered.filter(a => a.cleanup_status === pipelineFilter);
                }
            }
            
            if (pipelineSearchTerm) {
                filtered = filtered.filter(a => 
                    a.title.toLowerCase().includes(pipelineSearchTerm) ||
                    a.category.toLowerCase().includes(pipelineSearchTerm)
                );
            }

            if (filtered.length === 0) {
                document.getElementById('pipelineGrid').innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--text-muted);">No animations found</div>';
                return;
            }

            const gridHTML = filtered.map(anim => {
                const status = anim.cleanup_status || 'raw';
                const colors = {
                    raw: { bg: 'rgba(239, 68, 68, 0.1)', border: '#EF4444', text: '#EF4444' },
                    cleaning: { bg: 'rgba(245, 158, 11, 0.1)', border: '#F59E0B', text: '#F59E0B' },
                    cleaned: { bg: 'rgba(59, 130, 246, 0.1)', border: '#3B82F6', text: '#3B82F6' },
                    published: { bg: 'rgba(16, 185, 129, 0.1)', border: '#10B981', text: '#10B981' }
                };
                const c = colors[status] || colors.raw;

                return '<div style="background: var(--bg-card); border: 1px solid rgba(100, 116, 139, 0.1); border-radius: 12px; overflow: hidden;">' +
                    '<div style="position: relative; aspect-ratio: 1; background: #0a0a0a;">' +
                    (anim.video_url || anim.thumbnail_url ? 
                        '<img src="' + (anim.video_url || anim.thumbnail_url) + '" style="width: 100%; height: 100%; object-fit: cover;">' : 
                        '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">No preview</div>') +
                    '<div style="position: absolute; top: 12px; right: 12px; background: ' + c.bg + '; border: 1px solid ' + c.border + '; color: ' + c.text + '; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;">' + status.charAt(0).toUpperCase() + status.slice(1) + '</div>' +
                    '</div>' +
                    '<div style="padding: 16px;">' +
                    '<h3 style="color: var(--text-primary); font-size: 15px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + anim.title + '</h3>' +
                    '<p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">' + anim.category + ' - ' + (anim.duration || 'N/A') + '</p>' +
                    '<div style="display: flex; gap: 6px; flex-wrap: wrap;">' +
                    '<button onclick="updatePipelineStatus(' + anim.id + ', \'raw\')" class="btn btn-secondary" style="flex: 1; padding: 6px 8px; font-size: 11px;' + (status === 'raw' ? ' background: rgba(239, 68, 68, 0.2); border-color: #EF4444;' : '') + '">Raw</button>' +
                    '<button onclick="updatePipelineStatus(' + anim.id + ', \'cleaning\')" class="btn btn-secondary" style="flex: 1; padding: 6px 8px; font-size: 11px;' + (status === 'cleaning' ? ' background: rgba(245, 158, 11, 0.2); border-color: #F59E0B;' : '') + '">Cleaning</button>' +
                    '<button onclick="updatePipelineStatus(' + anim.id + ', \'cleaned\')" class="btn btn-secondary" style="flex: 1; padding: 6px 8px; font-size: 11px;' + (status === 'cleaned' ? ' background: rgba(59, 130, 246, 0.2); border-color: #3B82F6;' : '') + '">Cleaned</button>' +
                    '<button onclick="updatePipelineStatus(' + anim.id + ', \'published\')" class="btn btn-secondary" style="flex: 1; padding: 6px 8px; font-size: 11px;' + (status === 'published' ? ' background: rgba(16, 185, 129, 0.2); border-color: #10B981;' : '') + '">Published</button>' +
                    '</div></div></div>';
            }).join('');

            document.getElementById('pipelineGrid').innerHTML = gridHTML;
        }

        window.updatePipelineStatus = async function(animationId, newStatus) {
            console.log('Updating status:', animationId, newStatus);
            
            const { error } = await supabaseAdmin
                .from('animations')
                .update({ cleanup_status: newStatus })
                .eq('id', animationId);

            if (error) {
                console.error('Error updating status:', error);
                showNotification('Failed to update status: ' + error.message, 'error');
                return;
            }

            const anim = pipelineAnimations.find(a => a.id === animationId);
            if (anim) anim.cleanup_status = newStatus;

            updatePipelineStats();
            renderPipelineGrid();
            showNotification('Status updated to ' + newStatus, 'success');
        };

        // Load All Animations
        async function loadAllAnimations() {
            document.getElementById('animationsTable').innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            
            const { data: animations, error } = await supabaseAdmin
                .from('animations')
                .select('*')
                .order('created_at', { ascending: false });

            if (animations) {
                const tableHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Thumbnail</th>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Duration</th>
                                <th>Badges</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${animations.map(anim => `
                                <tr>
                                    <td>
                                        <img src="${anim.thumbnail_url || anim.video_url}" class="table-thumbnail" alt="${anim.title}">
                                    </td>
                                    <td>${anim.title}</td>
                                    <td>${anim.category}</td>
                                    <td>$${anim.price.toFixed(2)}</td>
                                    <td>${anim.duration}</td>
                                    <td>
                                        ${anim.popular ? '<span class="badge badge-popular">‚òÖ</span>' : ''}
                                        ${anim.on_sale ? '<span class="badge badge-sale">üè∑Ô∏è</span>' : ''}
                                        ${anim.holiday_sale ? '<span class="badge badge-holiday">üéÅ</span>' : ''}
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="action-btn edit" onclick="editAnimation('${anim.id}')">Edit</button>
                                            <button class="action-btn delete" onclick="deleteAnimation('${anim.id}', '${anim.title}')">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('animationsTable').innerHTML = tableHTML;
            }
        }

        // File Upload Handler
        function handleFileSelect(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            uploadedFiles[type] = file;

            const reader = new FileReader();
            reader.onload = function(e) {
                const previewDiv = document.getElementById(type + 'Preview');
                previewDiv.innerHTML = `
                    <div class="preview-item">
                        <img src="${e.target.result}" alt="Preview">
                        <button class="preview-remove" onclick="removeFile('${type}')" type="button">√ó</button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        function handleGlbSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            uploadedFiles.glb = file;
            
            const previewDiv = document.getElementById('glbPreview');
            previewDiv.innerHTML = `
                <div class="preview-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px;">
                    <span style="font-size: 24px;">üéÆ</span>
                    <div style="flex: 1;">
                        <div style="color: var(--text-primary); font-weight: 600;">${file.name}</div>
                        <div style="color: var(--text-muted); font-size: 12px;">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                    </div>
                    <button class="preview-remove" onclick="removeGlbFile()" type="button" style="position: relative; top: 0; right: 0;">√ó</button>
                </div>
            `;
        }

        function removeGlbFile() {
            uploadedFiles.glb = null;
            document.getElementById('glbPreview').innerHTML = '';
            document.getElementById('glbFile').value = '';
        }

        function removeFile(type) {
            uploadedFiles[type] = null;
            document.getElementById(type + 'Preview').innerHTML = '';
            document.getElementById(type + 'File').value = '';
        }

        // Add Animation
        async function handleAddAnimation(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke-width="4" stroke-dasharray="31.4" stroke-dashoffset="15.7"/></svg> Uploading...';
                
                let videoUrl = null;
                let thumbnailUrl = null;
                let downloadUrl = null;
                let videoType = 'image/gif';
                
                // Upload video/GIF file
                if (uploadedFiles.video) {
                    const file = uploadedFiles.video;
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                    
                    const { data: uploadData, error: uploadError } = await supabaseAdmin.storage
                        .from('animations')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (uploadError) throw uploadError;
                    
                    // Get public URL
                    const { data: { publicUrl } } = supabaseAdmin.storage
                        .from('animations')
                        .getPublicUrl(fileName);
                    
                    videoUrl = publicUrl;
                    videoType = file.type || 'image/gif';
                }
                
                // Upload thumbnail image
                if (uploadedFiles.thumbnail) {
                    const file = uploadedFiles.thumbnail;
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                    
                    const { data: uploadData, error: uploadError } = await supabaseAdmin.storage
                        .from('thumbnails')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (uploadError) throw uploadError;
                    
                    // Get public URL
                    const { data: { publicUrl } } = supabaseAdmin.storage
                        .from('thumbnails')
                        .getPublicUrl(fileName);
                    
                    thumbnailUrl = publicUrl;
                }
                
                // Upload downloadable file (if provided)
                if (uploadedFiles.download) {
                    const file = uploadedFiles.download;
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                    
                    const { data: uploadData, error: uploadError } = await supabaseAdmin.storage
                        .from('downloads')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (uploadError) throw uploadError;
                    
                    // Get public URL (for admin reference)
                    const { data: { publicUrl } } = supabaseAdmin.storage
                        .from('downloads')
                        .getPublicUrl(fileName);
                    
                    downloadUrl = publicUrl;
                }

                // Upload GLB file for 3D preview (if provided)
                let glbUrl = null;
                if (uploadedFiles.glb) {
                    const file = uploadedFiles.glb;
                    const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.glb`;
                    
                    const { data: uploadData, error: uploadError } = await supabaseAdmin.storage
                        .from('glb-previews')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (uploadError) throw uploadError;
                    
                    // Get public URL
                    const { data: { publicUrl } } = supabaseAdmin.storage
                        .from('glb-previews')
                        .getPublicUrl(fileName);
                    
                    glbUrl = publicUrl;
                }
                
                const animationData = {
                    title: formData.get('title'),
                    slug: formData.get('slug') || formData.get('title').toLowerCase().replace(/\s+/g, '-'),
                    description: formData.get('description'),
                    price: parseFloat(formData.get('price')),
                    duration: formData.get('duration'),
                    category: formData.get('category'),
                    sale_percentage: parseInt(formData.get('sale_percentage')) || null,
                    file_size: formData.get('file_size'),
                    frame_rate: formData.get('frame_rate'),
                    resolution: formData.get('resolution'),
                    format: formData.get('format'),
                    compatible_with: formData.get('compatible_with'),
                    popular: formData.get('popular') === 'on',
                    on_sale: formData.get('on_sale') === 'on',
                    holiday_sale: formData.get('holiday_sale') === 'on',
                    video_url: videoUrl || 'https://via.placeholder.com/400x300/1a1a2e/00d4ff?text=No+Video',
                    thumbnail_url: thumbnailUrl || videoUrl || 'https://via.placeholder.com/400x300/1a1a2e/00d4ff?text=No+Thumbnail',
                    file_url: downloadUrl,
                    glb_url: glbUrl,
                    video_type: videoType
                };

                const { data, error } = await supabaseAdmin
                    .from('animations')
                    .insert([animationData])
                    .select();

                if (error) throw error;
                
                showNotification('Animation created successfully!', 'success');
                event.target.reset();
                uploadedFiles = { video: null, thumbnail: null, download: null, glb: null };
                document.getElementById('videoPreview').innerHTML = '';
                document.getElementById('thumbnailPreview').innerHTML = '';
                document.getElementById('downloadPreview').innerHTML = '';
                document.getElementById('glbPreview').innerHTML = '';
                
                // Restore button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
            } catch (error) {
                console.error('Upload error:', error);
                showNotification('Error: ' + error.message, 'error');
                
                // Restore button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Create Animation';
            }
        }

        // Edit Animation
        async function editAnimation(id) {
            try {
                // Fetch the animation data
                const { data: anim, error } = await supabaseAdmin
                    .from('animations')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                // Populate the edit form
                document.getElementById('editAnimationId').value = anim.id;
                document.getElementById('editTitle').value = anim.title || '';
                document.getElementById('editSlug').value = anim.slug || '';
                document.getElementById('editDescription').value = anim.description || '';
                document.getElementById('editPrice').value = anim.price || '';
                document.getElementById('editDuration').value = anim.duration || '';
                document.getElementById('editCategory').value = anim.category || '';
                document.getElementById('editSalePercentage').value = anim.sale_percentage || '';
                document.getElementById('editFileSize').value = anim.file_size || '';
                document.getElementById('editFrameRate').value = anim.frame_rate || '';
                document.getElementById('editResolution').value = anim.resolution || '';
                document.getElementById('editFormat').value = anim.format || '';
                document.getElementById('editCompatibleWith').value = anim.compatible_with || '';
                document.getElementById('editVideoUrl').value = anim.video_url || '';
                document.getElementById('editThumbnailUrl').value = anim.thumbnail_url || '';
                document.getElementById('editGlbUrl').value = anim.glb_url || '';
                document.getElementById('editPopular').checked = anim.popular || false;
                document.getElementById('editOnSale').checked = anim.on_sale || false;
                document.getElementById('editHolidaySale').checked = anim.holiday_sale || false;

                // Show previews
                if (anim.video_url) {
                    document.getElementById('editVideoPreview').innerHTML = `<img src="${anim.video_url}" style="max-width: 150px; border-radius: 8px;">`;
                }
                if (anim.thumbnail_url) {
                    document.getElementById('editThumbnailPreview').innerHTML = `<img src="${anim.thumbnail_url}" style="max-width: 150px; border-radius: 8px;">`;
                }
                if (anim.glb_url) {
                    document.getElementById('editGlbPreview').innerHTML = `üéÆ GLB file linked - <a href="${anim.glb_url}" target="_blank" style="color: var(--teal);">View file</a>`;
                } else {
                    document.getElementById('editGlbPreview').innerHTML = 'No GLB file linked';
                }

                // Show modal
                document.getElementById('editModal').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading animation:', error);
                showNotification('Error loading animation: ' + error.message, 'error');
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editVideoPreview').innerHTML = '';
            document.getElementById('editThumbnailPreview').innerHTML = '';
            document.getElementById('editGlbPreview').innerHTML = '';
        }

        async function handleSaveEdit(event) {
            event.preventDefault();
            
            const id = document.getElementById('editAnimationId').value;
            const submitBtn = document.getElementById('editSubmitBtn');
            
            try {
                // Show loading state
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke-width="4" stroke-dasharray="31.4" stroke-dashoffset="15.7"/></svg> Saving...';

                const updateData = {
                    title: document.getElementById('editTitle').value,
                    slug: document.getElementById('editSlug').value,
                    description: document.getElementById('editDescription').value,
                    price: parseFloat(document.getElementById('editPrice').value),
                    duration: document.getElementById('editDuration').value,
                    category: document.getElementById('editCategory').value,
                    sale_percentage: parseInt(document.getElementById('editSalePercentage').value) || null,
                    file_size: document.getElementById('editFileSize').value || null,
                    frame_rate: document.getElementById('editFrameRate').value || null,
                    resolution: document.getElementById('editResolution').value || null,
                    format: document.getElementById('editFormat').value || null,
                    compatible_with: document.getElementById('editCompatibleWith').value || null,
                    video_url: document.getElementById('editVideoUrl').value || null,
                    thumbnail_url: document.getElementById('editThumbnailUrl').value || null,
                    glb_url: document.getElementById('editGlbUrl').value || null,
                    popular: document.getElementById('editPopular').checked,
                    on_sale: document.getElementById('editOnSale').checked,
                    holiday_sale: document.getElementById('editHolidaySale').checked
                };

                const { error } = await supabaseAdmin
                    .from('animations')
                    .update(updateData)
                    .eq('id', id);

                if (error) throw error;

                showNotification('Animation updated successfully!', 'success');
                closeEditModal();
                loadAllAnimations();
                loadOverviewStats();

            } catch (error) {
                console.error('Error updating animation:', error);
                showNotification('Error: ' + error.message, 'error');
            } finally {
                // Restore button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Save Changes';
            }
        }

        // Delete Animation
        async function deleteAnimation(id, title) {
            if (!confirm(`Are you sure you want to delete "${title}"?`)) return;

            const { error } = await supabaseAdmin
                .from('animations')
                .delete()
                .eq('id', id);

            if (error) {
                showNotification('Error: ' + error.message, 'error');
            } else {
                showNotification('Animation deleted successfully!', 'success');
                loadAllAnimations();
                loadOverviewStats();
            }
        }

        // Notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Drag and drop
        ['videoUpload', 'thumbnailUpload', 'downloadUpload'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    element.classList.add('dragover');
                });
                
                element.addEventListener('dragleave', () => {
                    element.classList.remove('dragover');
                });
                
                element.addEventListener('drop', (e) => {
                    e.preventDefault();
                    element.classList.remove('dragover');
                    const type = id === 'videoUpload' ? 'video' : id === 'thumbnailUpload' ? 'thumbnail' : 'download';
                    const file = e.dataTransfer.files[0];
                    if (file) {
                        const fileInput = document.getElementById(type + 'File');
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;
                        handleFileSelect({ target: fileInput }, type);
                    }
                });
            }
        });

        // Auto-generate slug from title
        document.querySelector('[name="title"]')?.addEventListener('input', (e) => {
            const slug = e.target.value
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-');
            document.querySelector('[name="slug"]').value = slug;
        });

        // ============================================
        // OFFERS MANAGEMENT FUNCTIONS
        // ============================================

        // Load offers settings from database
        async function loadOffers() {
            const { data: settings, error } = await supabaseAdmin
                .from('site_settings')
                .select('*');

            if (error) {
                console.error('Error loading offers:', error);
                // If table doesn't exist, create default settings
                await initializeOfferSettings();
                return;
            }

            // Create a map of settings
            const settingsMap = {};
            if (settings) {
                settings.forEach(s => settingsMap[s.key] = s.value === 'true');
            }

            // Update toggles
            const premiumBanner = settingsMap['premium_banner'] !== false;
            const rewardsBanner = settingsMap['rewards_banner'] !== false;
            const aiRecommendations = settingsMap['ai_recommendations'] !== false;
            const ctaBanner = settingsMap['cta_banner'] !== false;
            const specialOfferButton = settingsMap['special_offer_button'] !== false;

            document.getElementById('premiumBannerToggle').checked = premiumBanner;
            document.getElementById('rewardsBannerToggle').checked = rewardsBanner;
            document.getElementById('aiRecommendationsToggle').checked = aiRecommendations;
            document.getElementById('ctaBannerToggle').checked = ctaBanner;
            document.getElementById('specialOfferToggle').checked = specialOfferButton;

            document.getElementById('premiumBannerStatus').textContent = premiumBanner ? 'Visible' : 'Hidden';
            document.getElementById('rewardsBannerStatus').textContent = rewardsBanner ? 'Visible' : 'Hidden';
            document.getElementById('aiRecommendationsStatus').textContent = aiRecommendations ? 'Visible' : 'Hidden';
            document.getElementById('ctaBannerStatus').textContent = ctaBanner ? 'Visible' : 'Hidden';
            document.getElementById('specialOfferStatus').textContent = specialOfferButton ? 'Visible' : 'Hidden';

            // Update overall status
            const activeCount = [premiumBanner, rewardsBanner, aiRecommendations, ctaBanner, specialOfferButton].filter(Boolean).length;
            document.getElementById('offersStatus').textContent = `${activeCount}/5 Active`;
        }

        // Initialize default offer settings
        async function initializeOfferSettings() {
            const defaults = [
                { key: 'premium_banner', value: 'true' },
                { key: 'rewards_banner', value: 'true' },
                { key: 'ai_recommendations', value: 'true' },
                { key: 'cta_banner', value: 'true' },
                { key: 'special_offer_button', value: 'true' }
            ];

            for (const setting of defaults) {
                await supabaseAdmin
                    .from('site_settings')
                    .upsert(setting, { onConflict: 'key' });
            }

            loadOffers();
        }

        // Toggle offer visibility
        async function toggleOffer(key, enabled) {
            const { error } = await supabaseAdmin
                .from('site_settings')
                .upsert({ key, value: enabled.toString() }, { onConflict: 'key' });

            if (error) {
                console.error('Error updating offer:', error);
                showNotification('Failed to update setting', 'error');
                return;
            }

            // Update status text
            const statusMap = {
                'premium_banner': 'premiumBannerStatus',
                'rewards_banner': 'rewardsBannerStatus',
                'ai_recommendations': 'aiRecommendationsStatus',
                'cta_banner': 'ctaBannerStatus',
                'special_offer_button': 'specialOfferStatus'
            };

            document.getElementById(statusMap[key]).textContent = enabled ? 'Visible' : 'Hidden';

            // Update overall status count
            const activeCount = [
                document.getElementById('premiumBannerToggle').checked,
                document.getElementById('rewardsBannerToggle').checked,
                document.getElementById('aiRecommendationsToggle').checked,
                document.getElementById('ctaBannerToggle').checked,
                document.getElementById('specialOfferToggle').checked
            ].filter(Boolean).length;
            document.getElementById('offersStatus').textContent = `${activeCount}/5 Active`;

            showNotification(`${key.replace('_', ' ')} ${enabled ? 'enabled' : 'disabled'}`, 'success');
        }

        // ============================================
        // USER MANAGEMENT FUNCTIONS
        // ============================================

        // Load all users and admins
        async function loadUsers() {
            // Load admins
            loadAdmins();
            
            // Load all users
            document.getElementById('allUsersList').innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            
            const { data: users, error } = await supabaseAdmin.auth.admin.listUsers();
            
            if (error) {
                document.getElementById('allUsersList').innerHTML = '<p style="color: var(--red);">Error loading users. Make sure you have admin privileges.</p>';
                return;
            }

            // Get user roles
            const { data: roles } = await supabaseAdmin
                .from('user_roles')
                .select('*');

            const rolesMap = {};
            if (roles) {
                roles.forEach(r => rolesMap[r.user_id] = r.role);
            }

            // Update statistics
            const totalUsers = users.length;
            const adminCount = roles ? roles.filter(r => r.role === 'admin').length : 0;
            const regularUsers = totalUsers - adminCount;

            document.getElementById('totalUsersCount').textContent = totalUsers;
            document.getElementById('totalAdminsCount').textContent = adminCount;
            document.getElementById('regularUsersCount').textContent = regularUsers;

            const usersHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Signed Up</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.email}</td>
                                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                <td>
                                    ${rolesMap[user.id] === 'admin' 
                                        ? '<span class="badge badge-popular">Admin</span>' 
                                        : '<span class="badge" style="background: rgba(156, 163, 175, 0.2); color: var(--text-muted);">User</span>'}
                                </td>
                                <td>
                                    ${rolesMap[user.id] !== 'admin' 
                                        ? `<button class="action-btn edit" onclick="makeAdmin('${user.id}', '${user.email}')">Make Admin</button>`
                                        : user.id !== currentUser.id 
                                            ? `<button class="action-btn delete" onclick="removeAdmin('${user.id}', '${user.email}')">Remove Admin</button>`
                                            : '<span style="color: var(--text-muted); font-size: 12px;">You</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('allUsersList').innerHTML = usersHTML;
        }

        // Load admins only
        async function loadAdmins() {
            document.getElementById('adminsList').innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            
            // Get admin roles
            const { data: adminRoles, error } = await supabaseAdmin
                .from('user_roles')
                .select('*')
                .eq('role', 'admin');

            if (error) {
                document.getElementById('adminsList').innerHTML = '<p style="color: var(--red);">Error loading admins.</p>';
                return;
            }

            if (!adminRoles || adminRoles.length === 0) {
                document.getElementById('adminsList').innerHTML = '<p style="color: var(--text-muted);">No admins found.</p>';
                return;
            }

            // Get all users to match emails
            const { data: allUsers } = await supabaseAdmin.auth.admin.listUsers();
            const userMap = {};
            if (allUsers) {
                allUsers.forEach(u => userMap[u.id] = u);
            }

            const adminsHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Admin Since</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${adminRoles.map(admin => {
                            const user = userMap[admin.user_id];
                            return `
                                <tr>
                                    <td>${user?.email || admin.user_id}</td>
                                    <td>${new Date(admin.created_at).toLocaleDateString()}</td>
                                    <td>
                                        ${admin.user_id !== currentUser.id 
                                            ? `<button class="action-btn delete" onclick="removeAdmin('${admin.user_id}', '${user?.email || 'this user'}')">Remove</button>`
                                            : '<span style="color: var(--text-muted); font-size: 12px;">You</span>'}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('adminsList').innerHTML = adminsHTML;
        }

        // Add admin by email
        async function handleAddAdmin(event) {
            event.preventDefault();
            const email = event.target.admin_email.value;

            // First, get the user ID from email
            const { data: users } = await supabaseAdmin.auth.admin.listUsers();
            const user = users.find(u => u.email === email);

            if (!user) {
                showNotification(`User with email ${email} not found. They must sign up first.`, 'error');
                return;
            }

            // Add admin role
            const { error } = await supabaseAdmin
                .from('user_roles')
                .upsert({ 
                    user_id: user.id, 
                    role: 'admin' 
                });

            if (error) {
                showNotification('Error: ' + error.message, 'error');
            } else {
                showNotification(`${email} is now an admin!`, 'success');
                event.target.reset();
                loadUsers();
            }
        }

        // Make a user admin
        async function makeAdmin(userId, email) {
            if (!confirm(`Make ${email} an admin?`)) return;

            const { error } = await supabaseAdmin
                .from('user_roles')
                .upsert({ 
                    user_id: userId, 
                    role: 'admin' 
                });

            if (error) {
                showNotification('Error: ' + error.message, 'error');
            } else {
                showNotification(`${email} is now an admin!`, 'success');
                loadUsers();
            }
        }

        // Remove admin privileges
        async function removeAdmin(userId, email) {
            if (!confirm(`Remove admin access from ${email}?`)) return;

            const { error } = await supabaseAdmin
                .from('user_roles')
                .update({ role: 'user' })
                .eq('user_id', userId);

            if (error) {
                showNotification('Error: ' + error.message, 'error');
            } else {
                showNotification(`Admin access removed from ${email}`, 'success');
                loadUsers();
            }
        }

        // ===== CAROUSEL MANAGEMENT =====
        let carouselItems = [];

        async function loadCarouselItems() {
            try {
                const { data, error } = await supabaseAdmin
                    .from('carousel_items')
                    .select('*')
                    .order('position', { ascending: true });

                if (error) {
                    // If table doesn't exist, use default items
                    carouselItems = [
                        { position: 0, icon: 'üèÉ', title: 'Running Pack', subtitle: '12 animations', image_url: null, link_url: '' },
                        { position: 1, icon: '‚öîÔ∏è', title: 'Combat Pack', subtitle: '24 animations', image_url: null, link_url: '' },
                        { position: 2, icon: 'ü§∏', title: 'Acrobatic Pack', subtitle: '18 animations', image_url: null, link_url: '' },
                        { position: 3, icon: 'üßó', title: 'Climbing Pack', subtitle: '16 animations', image_url: null, link_url: '' },
                        { position: 4, icon: 'ü§æ', title: 'Sports Pack', subtitle: '20 animations', image_url: null, link_url: '' },
                        { position: 5, icon: 'üíÉ', title: 'Dance Pack', subtitle: '15 animations', image_url: null, link_url: '' },
                        { position: 6, icon: 'üßò', title: 'Idle Pack', subtitle: '10 animations', image_url: null, link_url: '' }
                    ];
                } else {
                    carouselItems = data;
                }

                renderCarouselItems();
            } catch (error) {
                console.error('Error loading carousel:', error);
                showNotification('Error loading carousel items', 'error');
            }
        }

        function renderCarouselItems() {
            const container = document.getElementById('carouselItemsList');
            if (!container) return;

            container.innerHTML = carouselItems.map((item, index) => `
                <div style="background: var(--bg-card); border: 1px solid rgba(100, 116, 139, 0.2); border-radius: 12px; padding: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="color: var(--text-white); font-size: 18px; font-weight: 600;">Item ${index + 1}</h3>
                        <span style="background: var(--teal); color: white; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">Position ${index + 1}</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">Icon (Emoji)</label>
                            <input type="text" 
                                   value="${item.icon}" 
                                   onchange="updateCarouselItem(${index}, 'icon', this.value)"
                                   style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 8px; color: var(--text-white); font-size: 24px; text-align: center;"
                                   placeholder="üéÆ">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">Title</label>
                            <input type="text" 
                                   value="${item.title}" 
                                   onchange="updateCarouselItem(${index}, 'title', this.value)"
                                   style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 8px; color: var(--text-white);"
                                   placeholder="Animation Pack">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">Subtitle</label>
                            <input type="text" 
                                   value="${item.subtitle}" 
                                   onchange="updateCarouselItem(${index}, 'subtitle', this.value)"
                                   style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 8px; color: var(--text-white);"
                                   placeholder="12 animations">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">Upload GIF/Image</label>
                            <input type="file" 
                                   accept="image/*,.gif"
                                   onchange="uploadCarouselImage(${index}, this)"
                                   style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 8px; color: var(--text-white);">
                            <div id="upload-status-${index}" style="font-size: 12px; margin-top: 4px; color: var(--text-secondary);"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px;">
                        <label style="display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">Or paste Image URL:</label>
                        <input type="text" 
                               value="${item.image_url || ''}" 
                               onchange="updateCarouselItem(${index}, 'image_url', this.value); renderCarouselItems();"
                               style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 8px; color: var(--text-white);"
                               placeholder="https://...">
                    </div>
                    
                    <div style="margin-top: 16px;">
                        <label style="display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">Link URL (where clicking goes):</label>
                        <input type="text" 
                               value="${item.link_url || ''}" 
                               onchange="updateCarouselItem(${index}, 'link_url', this.value)"
                               style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 8px; color: var(--text-white);"
                               placeholder="animation-detail.html?slug=combat-pack">
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Examples: animation-detail.html?slug=combat-pack or index.html#library</div>
                    </div>
                    
                    ${item.image_url ? `
                        <div style="margin-top: 16px;">
                            <label style="display: block; color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">Preview:</label>
                            <img src="${item.image_url}" style="width: 100%; max-width: 300px; height: auto; border-radius: 8px; border: 1px solid rgba(100, 116, 139, 0.3);">
                            <button onclick="removeCarouselImage(${index})" style="margin-top: 8px; padding: 8px 16px; background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.5); border-radius: 6px; color: #FF6B6B; cursor: pointer; font-size: 12px;">
                                Remove Image
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function updateCarouselItem(index, field, value) {
            carouselItems[index][field] = value;
        }

        function removeCarouselImage(index) {
            carouselItems[index].image_url = null;
            renderCarouselItems();
        }

        async function uploadCarouselImage(index, input) {
            const file = input.files[0];
            if (!file) return;

            const statusDiv = document.getElementById(`upload-status-${index}`);
            statusDiv.textContent = 'Uploading...';
            statusDiv.style.color = 'var(--teal)';

            try {
                // Create unique filename
                const timestamp = Date.now();
                const fileExt = file.name.split('.').pop();
                const fileName = `carousel-${index}-${timestamp}.${fileExt}`;
                const filePath = `carousel/${fileName}`;

                // Upload to Supabase Storage
                const { data, error } = await supabaseAdmin.storage
                    .from('animations')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) throw error;

                // Get public URL
                const { data: { publicUrl } } = supabaseAdmin.storage
                    .from('animations')
                    .getPublicUrl(filePath);

                // Update carousel item with new URL
                carouselItems[index].image_url = publicUrl;
                
                statusDiv.textContent = '‚úì Uploaded successfully!';
                statusDiv.style.color = '#10B981';
                
                // Re-render to show preview
                setTimeout(() => {
                    renderCarouselItems();
                }, 500);

            } catch (error) {
                console.error('Upload error:', error);
                statusDiv.textContent = '‚úó Upload failed: ' + error.message;
                statusDiv.style.color = '#FF6B6B';
            }
        }

        async function saveCarouselItems() {
            try {
                // Try to create table if it doesn't exist
                const { error: createError } = await supabaseAdmin.rpc('create_carousel_table', {});
                
                // Delete existing items
                await supabaseAdmin.from('carousel_items').delete().neq('position', -1);
                
                // Insert new items
                const { error } = await supabaseAdmin
                    .from('carousel_items')
                    .insert(carouselItems);

                if (error) {
                    showNotification('Error saving carousel: ' + error.message, 'error');
                } else {
                    showNotification('Carousel updated successfully!', 'success');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Note: Carousel updated locally. Database sync may require manual setup.', 'warning');
            }
        }

        // Initialize app
        init();
    </script>

    <!-- GIF Converter Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <script type="module">
        import * as THREE from 'https://esm.sh/three@0.160.0';
        import { GLTFLoader } from 'https://esm.sh/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';
        import { FBXLoader } from 'https://esm.sh/three@0.160.0/examples/jsm/loaders/FBXLoader.js';
        import { OrbitControls } from 'https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        // Bulk queue state
        let gifQueue = [];
        let gifResults = [];
        let gifWorkerBlob = null;

        // Fetch and create worker blob for local file support
        async function initGifWorker() {
            try {
                const response = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
                const text = await response.text();
                gifWorkerBlob = URL.createObjectURL(new Blob([text], { type: 'application/javascript' }));
            } catch (e) {
                console.warn('Could not fetch GIF worker, using default');
            }
        }

        // Initialize GIF Converter
        async function initGifConverter() {
            await initGifWorker();
            
            const dropZone = document.getElementById('gifDropZone');
            const fileInput = document.getElementById('gifFileInput');
            
            if (!dropZone || !fileInput) return;
            
            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--green)';
                dropZone.style.background = 'rgba(126, 211, 33, 0.1)';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.borderColor = 'rgba(126, 211, 33, 0.3)';
                dropZone.style.background = 'transparent';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'rgba(126, 211, 33, 0.3)';
                dropZone.style.background = 'transparent';
                
                const files = Array.from(e.dataTransfer.files).filter(f => 
                    f.name.endsWith('.glb') || f.name.endsWith('.fbx') || f.name.endsWith('.gltf')
                );
                if (files.length > 0) addFilesToQueue(files);
            });
            
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) addFilesToQueue(files);
                fileInput.value = '';
            });
            
            // Update all preview backgrounds when color changes
            document.getElementById('gifBackground').addEventListener('change', (e) => {
                const color = e.target.value;
                // Update all Three.js scenes
                gifQueue.forEach(item => {
                    if (item.scene) {
                        item.scene.background = new THREE.Color(color);
                    }
                });
                // Update preview container CSS backgrounds
                document.querySelectorAll('.item-preview').forEach(el => {
                    el.style.background = color;
                });
            });
        }

        // Add files to queue
        async function addFilesToQueue(files) {
            document.getElementById('gifQueue').style.display = 'block';
            
            for (const file of files) {
                const id = Date.now() + Math.random();
                const item = {
                    id,
                    file,
                    name: file.name.replace(/\.(glb|fbx|gltf)$/i, ''),
                    status: 'loading',
                    scene: null,
                    camera: null,
                    renderer: null,
                    controls: null,
                    mixer: null,
                    duration: 2,
                    blob: null
                };
                
                gifQueue.push(item);
                renderQueueItem(item);
                await setupItemPreview(item);
            }
        }

        // Render queue item card
        function renderQueueItem(item) {
            const list = document.getElementById('gifQueueList');
            
            const card = document.createElement('div');
            card.id = `queue-item-${item.id}`;
            card.style.cssText = 'background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; display: flex; gap: 16px; align-items: flex-start;';
            
            card.innerHTML = `
                <div class="item-preview" style="width: 280px; height: 280px; background: ${document.getElementById('gifBackground').value}; border-radius: 8px; overflow: hidden; flex-shrink: 0;">
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div>
                            <h4 style="color: var(--text-primary); margin: 0 0 4px 0; word-break: break-all;">${item.name}</h4>
                            <p class="item-status" style="color: var(--text-muted); font-size: 13px; margin: 0;">Loading...</p>
                        </div>
                        <button onclick="removeFromQueue(${item.id})" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;">
                            <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="item-controls" style="display: none; gap: 6px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="setItemAngle(${item.id}, 0)">Front</button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="setItemAngle(${item.id}, 45)">45¬∞</button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="setItemAngle(${item.id}, 90)">Side</button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="setItemAngle(${item.id}, 135)">135¬∞</button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="setItemAngle(${item.id}, 180)">Back</button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="zoomInItem(${item.id})">+</button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="zoomOutItem(${item.id})">-</button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="resetItemCamera(${item.id})">Reset</button>
                    </div>
                </div>
            `;
            
            list.appendChild(card);
        }

        // Setup preview for queue item
        async function setupItemPreview(item) {
            const card = document.getElementById(`queue-item-${item.id}`);
            const previewContainer = card.querySelector('.item-preview');
            const statusEl = card.querySelector('.item-status');
            const controlsEl = card.querySelector('.item-controls');
            
            // Create Three.js scene for this item
            const scene = new THREE.Scene();
            const bgColor = document.getElementById('gifBackground').value;
            scene.background = new THREE.Color(bgColor);
            
            const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
            camera.position.set(0, 1.5, 4);
            
            const renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(280, 280);
            renderer.setPixelRatio(1);
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            
            // Lighting
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
            hemiLight.position.set(0, 20, 0);
            scene.add(hemiLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);
            const backLight = new THREE.DirectionalLight(0x7ED321, 0.4);
            backLight.position.set(-5, 5, -5);
            scene.add(backLight);
            
            // Controls
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 1, 0);
            
            item.scene = scene;
            item.camera = camera;
            item.renderer = renderer;
            item.controls = controls;
            
            // Load model
            const url = URL.createObjectURL(item.file);
            const ext = item.file.name.split('.').pop().toLowerCase();
            const loader = ext === 'fbx' ? new FBXLoader() : new GLTFLoader();
            
            try {
                const result = await new Promise((resolve, reject) => {
                    loader.load(url, resolve, undefined, reject);
                });
                
                const model = ext === 'fbx' ? result : result.scene;
                const anims = result.animations || [];
                
                model.traverse(child => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                        child.frustumCulled = false;
                    }
                });
                
                // Center and scale
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                
                model.position.x = -center.x;
                model.position.z = -center.z;
                model.position.y = -box.min.y;
                
                const maxDim = Math.max(size.x, size.y, size.z);
                if (maxDim > 2) {
                    model.scale.setScalar(2 / maxDim);
                }
                
                scene.add(model);
                item.model = model;
                
                // Animation
                if (anims.length > 0) {
                    item.duration = anims[0].duration;
                    item.mixer = new THREE.AnimationMixer(model);
                    item.animations = anims;
                    const action = item.mixer.clipAction(anims[0]);
                    action.play();
                }
                
                // Show preview
                previewContainer.innerHTML = '';
                previewContainer.appendChild(renderer.domElement);
                
                item.status = 'ready';
                statusEl.textContent = `Ready - ${item.duration.toFixed(1)}s`;
                statusEl.style.color = 'var(--green)';
                controlsEl.style.display = 'flex';
                
                // Start animation loop for this item
                const clock = new THREE.Clock();
                item.clock = clock;
                
                function animate() {
                    if (!item.renderer) return;
                    item.animId = requestAnimationFrame(animate);
                    const delta = clock.getDelta();
                    if (item.mixer) item.mixer.update(delta);
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();
                
                URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Error loading:', error);
                item.status = 'error';
                statusEl.textContent = 'Error loading file';
                statusEl.style.color = '#ef4444';
            }
        }

        // Remove from queue
        window.removeFromQueue = function(id) {
            const idx = gifQueue.findIndex(i => i.id === id);
            if (idx > -1) {
                const item = gifQueue[idx];
                if (item.animId) cancelAnimationFrame(item.animId);
                if (item.renderer) item.renderer.dispose();
                gifQueue.splice(idx, 1);
            }
            document.getElementById(`queue-item-${id}`)?.remove();
            
            if (gifQueue.length === 0) {
                document.getElementById('gifQueue').style.display = 'none';
            }
        };

        // Clear queue
        window.clearGifQueue = function() {
            gifQueue.forEach(item => {
                if (item.animId) cancelAnimationFrame(item.animId);
                if (item.renderer) item.renderer.dispose();
            });
            gifQueue = [];
            document.getElementById('gifQueueList').innerHTML = '';
            document.getElementById('gifQueue').style.display = 'none';
        };

        // Camera controls for items
        window.setItemAngle = function(id, degrees) {
            const item = gifQueue.find(i => i.id === id);
            if (item) {
                const radians = degrees * (Math.PI / 180);
                const distance = item.camera.position.length();
                const height = item.camera.position.y;
                
                item.camera.position.x = Math.sin(radians) * distance * 0.8;
                item.camera.position.z = Math.cos(radians) * distance * 0.8;
                item.camera.position.y = height;
                item.controls.update();
            }
        };

        window.resetItemCamera = function(id) {
            const item = gifQueue.find(i => i.id === id);
            if (item) {
                item.camera.position.set(0, 1.5, 4);
                item.controls.target.set(0, 1, 0);
                item.controls.update();
            }
        };

        window.zoomInItem = function(id) {
            const item = gifQueue.find(i => i.id === id);
            if (item) {
                item.camera.position.multiplyScalar(0.8);
                item.controls.update();
            }
        };

        window.zoomOutItem = function(id) {
            const item = gifQueue.find(i => i.id === id);
            if (item) {
                item.camera.position.multiplyScalar(1.25);
                item.controls.update();
            }
        };

        // Convert all GIFs
        window.convertAllGifs = async function() {
            const readyItems = gifQueue.filter(i => i.status === 'ready');
            if (readyItems.length === 0) return;
            
            const bgColor = document.getElementById('gifBackground').value;
            
            document.getElementById('batchProgress').style.display = 'block';
            document.getElementById('convertAllBtn').disabled = true;
            document.getElementById('batchProgressPercent').textContent = '0%';
            document.getElementById('batchProgressCount').textContent = `0/${readyItems.length} files`;
            document.getElementById('batchProgressLabel').textContent = 'Starting conversion...';
            document.getElementById('batchProgressDetail').textContent = 'Preparing files...';
            
            gifResults = [];
            
            for (let i = 0; i < readyItems.length; i++) {
                const item = readyItems[i];
                const overallPercent = Math.round((i / readyItems.length) * 100);
                
                // Update progress
                document.getElementById('batchProgressLabel').textContent = `Converting: ${item.name}`;
                document.getElementById('batchProgressDetail').textContent = 'Capturing frames...';
                document.getElementById('batchProgressPercent').textContent = `${overallPercent}%`;
                document.getElementById('batchProgressCount').textContent = `${i + 1}/${readyItems.length} files`;
                document.getElementById('batchProgressBar').style.width = `${overallPercent}%`;
                
                // Update item status
                const card = document.getElementById(`queue-item-${item.id}`);
                const statusEl = card.querySelector('.item-status');
                statusEl.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 6px;"><span class="mini-spinner" style="width: 12px; height: 12px; border: 2px solid rgba(126, 211, 33, 0.2); border-top-color: var(--green); border-radius: 50%; animation: spin 1s linear infinite;"></span> Converting...</span>';
                statusEl.style.color = 'var(--amber)';
                
                try {
                    const blob = await convertItemToGif(item, bgColor, (phase, frameProgress) => {
                        // Update detail text during conversion
                        if (phase === 'capturing') {
                            document.getElementById('batchProgressDetail').textContent = `Capturing frame ${frameProgress}...`;
                        } else if (phase === 'encoding') {
                            document.getElementById('batchProgressDetail').textContent = `Encoding GIF... ${frameProgress}%`;
                        }
                    });
                    gifResults.push({ name: item.name, blob, url: URL.createObjectURL(blob) });
                    
                    statusEl.textContent = '‚úì Done!';
                    statusEl.style.color = 'var(--green)';
                } catch (error) {
                    console.error('Convert error:', error);
                    statusEl.textContent = '‚úó Failed';
                    statusEl.style.color = '#ef4444';
                }
            }
            
            document.getElementById('batchProgressBar').style.width = '100%';
            document.getElementById('batchProgressPercent').textContent = '100%';
            document.getElementById('batchProgressLabel').textContent = 'üéâ Complete!';
            document.getElementById('batchProgressDetail').textContent = `Successfully converted ${gifResults.length} files`;
            document.getElementById('convertAllBtn').disabled = false;
            
            // Show results
            showResults();
        };

        // Convert single item to GIF
        async function convertItemToGif(item, bgColor, onProgress) {
            return new Promise(async (resolve, reject) => {
                const width = 400;
                const height = 400;
                const fps = 30;
                const frameCount = Math.ceil(item.duration * fps);
                const delay = Math.round(1000 / fps);
                
                // Resize renderer
                item.renderer.setSize(width, height);
                item.camera.aspect = 1;
                item.camera.updateProjectionMatrix();
                
                // Set background
                item.scene.background = new THREE.Color(bgColor);
                
                // Stop animation loop
                if (item.animId) cancelAnimationFrame(item.animId);
                
                // Create GIF
                const gifOptions = {
                    workers: 4,
                    quality: 1,
                    width,
                    height,
                    dither: false
                };
                if (gifWorkerBlob) gifOptions.workerScript = gifWorkerBlob;
                
                const gif = new GIF(gifOptions);
                
                // Reset animation
                if (item.mixer) item.mixer.setTime(0);
                
                // Capture frames
                const timeStep = item.duration / frameCount;
                
                for (let i = 0; i < frameCount; i++) {
                    if (item.mixer) item.mixer.setTime(i * timeStep);
                    item.renderer.render(item.scene, item.camera);
                    gif.addFrame(item.renderer.domElement, { copy: true, delay });
                    
                    // Report progress
                    if (onProgress) onProgress('capturing', `${i + 1}/${frameCount}`);
                    
                    await new Promise(r => setTimeout(r, 5));
                }
                
                gif.on('progress', (p) => {
                    if (onProgress) onProgress('encoding', Math.round(p * 100));
                });
                
                gif.on('finished', (blob) => {
                    // Reset renderer size
                    item.renderer.setSize(280, 280);
                    item.camera.aspect = 1;
                    item.camera.updateProjectionMatrix();
                    
                    // Restart animation
                    item.clock.getDelta();
                    function animate() {
                        if (!item.renderer) return;
                        item.animId = requestAnimationFrame(animate);
                        const delta = item.clock.getDelta();
                        if (item.mixer) item.mixer.update(delta);
                        item.controls.update();
                        item.renderer.render(item.scene, item.camera);
                    }
                    animate();
                    
                    resolve(blob);
                });
                
                gif.on('error', reject);
                gif.render();
            });
        }

        // Show results
        function showResults() {
            const resultsDiv = document.getElementById('gifResults');
            const resultsList = document.getElementById('gifResultsList');
            
            resultsDiv.style.display = 'block';
            resultsList.innerHTML = '';
            
            gifResults.forEach(result => {
                const card = document.createElement('div');
                card.style.cssText = 'background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; text-align: center;';
                card.innerHTML = `
                    <img src="${result.url}" style="width: 100%; border-radius: 6px; margin-bottom: 8px;">
                    <p style="color: var(--text-primary); font-size: 13px; margin: 0 0 8px 0; word-break: break-all;">${result.name}</p>
                    <a href="${result.url}" download="${result.name}.gif" class="btn btn-secondary" style="width: 100%; padding: 6px 12px; font-size: 13px;">Download</a>
                `;
                resultsList.appendChild(card);
            });
        }

        // Download all GIFs
        window.downloadAllGifs = function() {
            gifResults.forEach(result => {
                const link = document.createElement('a');
                link.href = result.url;
                link.download = `${result.name}.gif`;
                link.click();
            });
        };

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGifConverter);
        } else {
            initGifConverter();
        }
    </script>
</body>
</html>
